#include "includeme.h"
#include "kfd.h"
#include "virtrw.h"

uint64_t cpuTTEP = 0;

int (*physreadbuf)(uint64_t addr, void *buffer, size_t len);
int (*physwritebuf)(uint64_t addr, void *buffer, size_t len);

uint64_t rp64(uint64_t addr) {
    uint64_t result = 0;
    physreadbuf(addr, &result, sizeof(uint64_t));
    
    return result;
}

uint32_t rp32(uint64_t addr) {
    uint32_t result = 0;
    physreadbuf(addr, &result, sizeof(uint32_t));
    
    return result;
}

uint16_t rp16(uint64_t addr) {
    uint16_t result = 0;
    physreadbuf(addr, &result, sizeof(uint16_t));
    
    return result;
}

uint8_t rp8(uint64_t addr) {
    uint8_t result = 0;
    physreadbuf(addr, &result, sizeof(uint8_t));
    
    return result;
}

uint64_t translateAddr_inTTEP(uint64_t ttep, uint64_t virt) {
    uint64_t table1Off = (virt >> 36ULL) & 0x7ULL;
    uint64_t table1Entry = rp64(ttep + (8ULL * table1Off));
    guard ((table1Entry & 0x3) == 3) else {
        //throw MemoryAccessError.failedToTranslate(address: virt, table: "table1", entry: table1Entry)
        return 0;
    }
    
    uint64_t table2 = table1Entry & 0xFFFFFFFFC000ULL;
    uint64_t table2Off = (virt >> 25ULL) & 0x7FFULL;
    uint64_t table2Entry = rp64(table2 + (8ULL * table2Off));
    switch (table2Entry & 0x3) {
        case 1:
            // Easy, this is a block
            return (table2Entry & 0xFFFFFE000000ULL) | (virt & 0x1FFFFFFULL);
            
        case 3: {
            uint64_t table3 = table2Entry & 0xFFFFFFFFC000ULL;
            uint64_t table3Off = (virt >> 14ULL) & 0x7FFULL;
            uint64_t table3Entry = rp64(table3 + (8ULL * table3Off));
            
            guard ((table3Entry & 0x3) == 3) else {
                //throw MemoryAccessError.failedToTranslate(address: virt, table: "table3", entry: table3Entry)
                return 0;
            }
            
            return (table3Entry & 0xFFFFFFFFC000ULL) | (virt & 0x3FFFULL);
        }
            
        default:
            return 0;
    }
}

/*uint64_t translateAddr(uint64_t virt)
{
    return translateAddr_inTTEP(cpuTTEP, virt);
}*/
