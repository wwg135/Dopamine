SDK=iphoneos
TARGET=arm64-apple-ios15.0

CC=xcrun -sdk $(SDK) clang

WARNINGS=-Wall -Wpedantic -Werror
CFLAGS=-target $(TARGET) -Os -fobjc-arc -Wno-gnu -Wno-deprecated-declarations
LDFLAGS=-target $(TARGET) -framework Foundation -framework IOKit -framework IOSurface -lcompression

SOURCES=$(wildcard Sources/*.c) $(wildcard Sources/*.m) $(wildcard Sources/*.S) $(wildcard Sources/golb/*.c) 
OBJS=$(addprefix build/,$(patsubst %.c,%.o,$(patsubst %.S,%.o,$(patsubst %.m,%.o,$(SOURCES)))))

HEADERS=$(wildcard Sources/*.h)

OUTPUT_DIRS=$(dir $(OBJS))

all: oobPCI

.PHONY: all build_clean clean

oobPCI: build/oobPCI
	@cp $< $@
	@chmod +x $@
	@ldid -SoobPCI.entitlements $@

build/oobPCI: ensure_output_dirs $(OBJS)
	$(CC) -o $@ $(OBJS) $(LDFLAGS)

build/%.o: %.c $(HEADERS)
	$(CC) -c -o $@ $< $(CFLAGS)

build/%.o: %.m $(HEADERS)
	$(CC) -c -o $@ $< $(CFLAGS)

build/%.o: %.S $(HEADERS)
	$(CC) -c -o $@ $< $(CFLAGS) --std=c++11

ensure_output_dirs:
	mkdir -p $(OUTPUT_DIRS)

build_clean:
	rm -rf build

clean: build_clean
	rm -f oobPCI
