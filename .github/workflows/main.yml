name: build_Release
on:
  push:
    branches:
      - 1.0.5-test
    paths-ignore:
      - ".gitignore"
  workflow_dispatch:

env:
  VERSION: '1.0.5_5'

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Procursus
        uses: wwg135/procursus-action@main
        with:
          packages: ldid trustcache make findutils coreutils

      - name: Install THEOS
        run: |
         curl -fsSL https://raw.githubusercontent.com/theos/theos/master/bin/install-theos > theos
         sed -i '' 's/get_sdks$//g' theos
         bash theos

      - name: Set env
        run: |
          sT=$(TZ=UTC-8 date +'%S')
          echo "msT=$(date -j -f "%Y-%m-%d %H:%M:%S" "$(TZ=UTC-8 date +'%Y-%m-%d %H:%M'):${sT}" +%s)" >> $GITHUB_ENV
          echo "shT=$(TZ=UTC-8 date +'%Y-%m-%d'' ''%H:%M:%S')" >> $GITHUB_ENV
          echo "logT=$(TZ=UTC-8 date +'%Y年%m月%d %H:%M'):${sT}" >> $GITHUB_ENV

      - name: Print env
        run: |
          echo ${{ env.VERSION }}
          echo ${{ env.msT }}
          echo ${{ env.shT }}
          echo ${{ env.logT }}

      - name: Pre code and keychain
        run: |
          sed -i '' "s/AAA/更新时间/g" ./Dopamine/Dopamine/UI/Views/JailbreakView.swift
          sed -i '' "s/AAB/${{ env.shT }}/g" ./Dopamine/Dopamine/UI/Views/JailbreakView.swift
          sed -i '' 's/MARKETING_VERSION = .*;/MARKETING_VERSION = ${{ env.VERSION }};/g' ./Dopamine/Dopamine.xcodeproj/project.pbxproj
          sudo security import Exploits/fastPath/arm.pfx -k /Library/Keychains/System.keychain -P password -A
      
      - name: Pre body
        run: |
          echo -e "[点击当前版本下载](https://github.com/wwg135/Dopamine/releases/download/${{ env.msT }}/Dopamine.ipa)" >> body.txt
          echo -e "\n更新时间：${{ env.logT }}" >> body.txt
          echo -e "\n**当前更新日志如下：**" >> body.txt
          echo -e "\n> - 维护更新1.0.5版本，1.1以上版本可忽略更新" >> body.txt
          echo -e "\n1.0.5_2的修改版功能如下：" >> body.txt
          echo -e "**注意：追求稳定，此版本无【桥接心浪】、【映射挂载】、【重建环境】功能**" >> body.txt
          echo -e "> - 1、新增【检查更新】功能，设置里面打开即可检查更新，默认关闭！！！" >> body.txt
          echo -e "> - 2、新增初次越狱/重建越狱时，默认安装 【ElleKit_1.0】 和 【PreferenceLoader_2.2.6.1】。感谢liam0205大佬的代码！！！" >> body.txt
          echo -e "> - 3、首页新增【系统运行时间】----越狱后显示，打开多巴胺即弹出！！！" >> body.txt
          echo -e "> - 4、长按【重启用户空间】3Dtouch弹出的【重启】功能才是真正重启手机（此操作重启后处于非越狱状态，谨慎操作）！！！" >> body.txt
          echo -e "> - 5、新增【自定义dopamine首页背景】--将图片命名为：Wallpaper.jpg放置在目录：/var/mobile/！！！" >> body.txt
          echo -e "> - 6、新增【底层屏蔽】越狱检测，将自定义的屏蔽越狱检测配置文件：zp.unject.plist放置在目录：/var/mobile/！！！" >> body.txt
          echo -e "> - 7、其他设置UI、显示细节优化！！！" >> body.txt
      
      - name: Build ipa
        run: |
          set -x
          export THEOS=$HOME/theos
          gmake -j$(sysctl -n hw.physicalcpu)
          mv Dopamine/Dopamine.tipa Dopamine.ipa

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.VERSION }}
          tag_name: ${{ env.msT }}
          target_commitish: 1.0.5
          body_path: body.txt
          latest: true
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          files: |
           *.ipa

      - name: Upload Artifact
        id: dopamine-upload
        uses: actions/upload-artifact@v3
        with:
          name: Dopamine
          path: |
            Dopamine.ipa
